<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <link rel="stylesheet" href="style.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/ScrollMagic.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/plugins/debug.addIndicators.min.js"></script>
    <script src="grid.js"></script>
    <script src="utils.js"></script>
    <script>
      let controller;
      const scenes = { 1: [], 2: [], 3: [] };
      function setPage() {
        const newPage = location.hash.substr(1) || "home";
        document.querySelector("body").setAttribute("class", `page-${newPage}`);
        scrollTo(0, 0);
        gridify();
      }
      function moveTo(scene) {
        controller.scrollTo(scene);
      }
      function setEventActive(el, event, scene) {
        document.getElementById("year").innerHTML = event.year;
        scene.duration(el.clientHeight + 24 * 3);
      }
      function setEraActive(era) {
        const classes = document.getElementById("container").classList;
        classes.remove(
          Array.from(classes).filter((c) => c.startsWith("activeEra"))
        );
        classes.add(`activeEra${era}`);
      }
      function setupScrolling(el, event, era) {
        const scene = new ScrollMagic.Scene({
          triggerElement: el,
          offset: -20,
          triggerHook: 0.15,
        });
        scenes[era].push(scene);
        scene
          .addIndicators()
          .setClassToggle(`#thumb-${el.id}`, "showing")
          .on("enter", () => {
            setEventActive(el, event, scene);
            setEraActive(era);
          })
          .addTo(controller);
      }
    </script>
  </head>
  <body class="page-timeline">
    <div id="topBar">
      <a href="#about" id="link-about"> /about </a>
      <a id="link-home" href="#home">
        <svg height="1rem" viewBox="0 96 960 960" width="48">
          <path d="M160 936V456l320-240 320 240v480H560V656H400v280H160Z" />
        </svg>
      </a>
    </div>

    <div id="container" class="gridded activeEra1">
      <div id="eraMenu" v-scope>
        <a href="#timeline" v-for="era in eras" :class="`${era.color}Backed`">
          {{era.first_year}} &ndash; {{era.last_year}}:<br />
          {{era.slug}}
        </a>
      </div>

      <div id="page-about" v-scope>
        <div class="title orangeBacked box">
          How did we get here? Image manipulation, from darkroom to AI
        </div>
        <div
          class="box yellowBacked"
          style="margin-left: 12rem; width: 18rem"
          v-html="s.about"
        ></div>
      </div>

      <div id="page-timeline">
        <div id="nav" v-scope>
          <div id="context">
            <div id="legend" class="box">
              <div class="box">Legend entry 1</div>
              <div class="box">Legend entry 2</div>
              <div class="box">Legend entry 3</div>
            </div>
            <div id="year" class="box"></div>
          </div>

          <div
            v-for="era in eras"
            :id="`era${era.era}`"
            :class="['imageContainer','box',`${era.color}Backed`]"
          >
            <div class="imageGrid box">
              <div
                v-for="i in 18"
                class="imageThumb"
                :id="`thumb-era${era.era}-event${i}`"
                @click="moveTo(scenes[era.era][i - 1])"
              >
                <img
                  v-if="i < eraEvents(era.era).length + 1"
                  :src="eraEvents(era.era)[i - 1].image_url"
                />
              </div>
            </div>
          </div>
        </div>

        <div id="contentCol" class="box">
          <div id="events" v-scope>
            <div v-for="era in eras">
              <h4>PART {{era.era}}</h4>
              <h3>{{era.title}}</h3>
              <ol>
                <li
                  v-for="(event, index) in eraEvents(era.era)"
                  :id="`era${era.era}-event${index + 1}`"
                  class="event"
                  @vue:mounted="setupScrolling($el, event, era.era)"
                >
                  <div class="eventImage">
                    <img :src="event.image_url" />
                  </div>
                  <div class="eventData">
                    <div class="eventTitle">{{event.title}}</div>
                    <p class="eventText">{{event.text}}</p>
                  </div>
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <div id="page-home" v-scope>
        <div
          class="box"
          style="
            width: calc(24rem + 2px);
            margin-left: 1rem;
            margin-top: 1rem;
            height: calc(5rem + 1px);
          "
        >
          <h1>{{s.title}}</h1>
        </div>
        <div
          class="box"
          style="
            width: calc(28rem + 2px);
            margin-left: 2rem;
            margin-top: calc(1rem - 1px);
            height: calc(3rem + 1px);
          "
        >
          <h2>{{s.subtitle}}</h2>
        </div>
        <div
          class="box"
          style="
            width: calc(21rem + 2px);
            margin-left: 8rem;
            margin-top: calc(2rem - 1px);
            height: calc(4rem + 1px);
          "
        >
          <p v-html="s.enticement"></p>
        </div>

        <div
          class="box"
          style="
            width: calc(21rem + 2px);
            margin-left: 4rem;
            margin-top: calc(4rem - 1px);
            height: calc(26rem + 1px);
          "
          v-html="s.overview"
        ></div>

        <div
          class="box"
          style="
            width: calc(28rem + 2px);
            margin-left: 2rem;
            margin-top: calc(2rem - 1px);
            margin-bottom: 1rem;
            height: calc(14rem + 1px);
          "
        >
          <img
            :src="s.example_img"
            style="
              display: inline-block;
              width: 40%;
              vertical-align: top;
              margin-top: 1rem;
            "
          />
          <p
            style="
              display: inline-block;
              width: 48%;
              border-left: 2px solid black;
              padding: 0.5rem 0 0.5rem 1rem;
              margin-left: 1rem;
            "
          >
            {{s.example}}
          </p>

          <a href="#timeline" id="next" class="box">
            <svg>
              <defs>
                <marker
                  id="head"
                  orient="auto"
                  markerWidth="3"
                  markerHeight="4"
                  refX="0.1"
                  refY="2"
                >
                  <path d="M0,0 V4 L2,2 Z" fill="black" />
                </marker>
              </defs>

              <path
                id="arrow-line"
                marker-end="url(#head)"
                fill="none"
                stroke="black"
                stroke-width="3"
                d="M15,35, 50 35"
              ></path>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      import { createApp } from "https://unpkg.com/petite-vue?module";

      function populateApp(timeline, eras, strings) {
        eras = parseCSVtoObjects(eras);
        let events = parseCSVtoObjects(timeline);
        strings = Object.fromEntries(
          parseCSVtoObjects(strings).map((r) => [r.name, r.text])
        );
        console.log(events);
        console.log(eras);

        controller = new ScrollMagic.Controller({
          container: "#contentCol",
        });

        createApp({
          events: events,
          eras: eras,
          eraEvents(i) {
            return this.events.filter((e) => e.era === i);
          },
        }).mount("#events");

        createApp({
          s: strings,
        }).mount("#page-home");

        createApp({
          s: strings,
        }).mount("#page-about");

        createApp({
          eras: eras,
        }).mount("#eraMenu");

        createApp({
          events: events,
          eras: eras,
          eraEvents(i) {
            return this.events.filter((e) => e.era === i);
          },
        }).mount("#nav");
        gridify(false);
        addEventListener("hashchange", setPage);
        setPage();
      }

      const timelineURL =
        "https://docs.google.com/spreadsheets/d/1fpHxE_ketMRAzXCKKmMwXxHpvdlT8GNdPWeugIUZ0D0/gviz/tq?tqx=out:csv";
      const erasURL =
        "https://docs.google.com/spreadsheets/d/1fpHxE_ketMRAzXCKKmMwXxHpvdlT8GNdPWeugIUZ0D0/gviz/tq?gid=1115017889&tqx=out:csv";
      const stringsURL =
        "https://docs.google.com/spreadsheets/d/1fpHxE_ketMRAzXCKKmMwXxHpvdlT8GNdPWeugIUZ0D0/gviz/tq?gid=1102126140&tqx=out:csv";

      Promise.all([fetch(timelineURL), fetch(erasURL), fetch(stringsURL)])
        .then((responses) => Promise.all(responses.map((r) => r.text())))
        .then((texts) => {
          if (document.readyState === "loading") {
            document.addEventListener(
              "DOMContentLoaded",
              populateApp(...texts)
            );
          } else {
            populateApp(...texts);
          }
        });
    </script>
  </body>
</html>
